
```{r}
library(tidyverse)
library(readxl)
library(tsibble)
library(feasts)
library(generics)
```

```{r}
url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2019_CEDR_tidal_data_01jun21.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_19 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2018_CEDR_tidal_data_01jun21.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_18 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2017_CEDR_tidal_data_11oct18.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_17 <-read_excel(path = tf)

url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2016_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_16 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2015_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_15 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2014_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_14 <-read_excel(path = tf)

url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2013_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_13 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2012_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_12 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2011_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_11 <-read_excel(path = tf)

url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2010_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_10 <-read_excel(path = tf)

wq <- rbind(wq_10, wq_11, wq_12, wq_13, wq_14, wq_15, wq_16, wq_17, wq_18, wq_19)

rm(wq_10, wq_11, wq_12, wq_13, wq_14, wq_15, wq_16, wq_17, wq_18, wq_19)
```

```{r}
wq <- wq %>%
  select("MonitoringLocation", "SampleDate", "Parameter", "MeasureValue", "Unit", "Latitude", "Longitude") %>% 
  filter(Parameter=="TP")

class(wq$SampleDate)
```

```{r}
wq_monthly_avgs_ts <- wq %>% 
  mutate(yr_mo = tsibble::yearmonth(SampleDate)) %>%
  group_by(yr_mo) %>%
  summarize(monthly_avg = mean(MeasureValue, na.rm = TRUE)) %>% 
  as_tsibble()
```

```{r}
class(wq_monthly_avgs_ts)
```



```{r}
wq_monthly_avgs_df <- as.data.frame(wq_monthly_avgs_ts)
wq_monthly_avgs_df$yr_mo <- as.Date(wq_monthly_avgs_ts$yr_mo, format = "%Y-%m")

wq_monthly_avgs_df %>%
  ggplot(aes(yr_mo, monthly_avg)) +
  stat_summary(geom = 'line', fun = 'mean') +
  geom_smooth(se = FALSE, color = 'blue') +
  labs(x = 'Year-Month', y = 'Average TN measurement (mg/L)', title = "Nitrogen Pollution in Chesapeake Bay (2010-2019)") +
  scale_x_date(date_breaks = "1 year", date_minor_breaks = "6 months", date_labels = "%Y-%m") +
  theme_bw()
```



```{r}
wq_monthly_avgs$yr_mo <- as.yearmon(wq_monthly_avgs$yr_mo, format = "%Y-%m")
```

```{r}
decomp_monthly <- wq_monthly_avgs %>%
  fabletools::model(feasts::STL(monthly_avg, t.window = 12)) %>% 
  generics::components()

decomp_monthly %>%
  autoplot() +
  labs(title = "Monthly Time Series Analysis of P", x = "Year-Month")
```

```{r}
acf(wq_monthly_avgs_ts, lag.max = 11)
```


```{r}
wq_monthly_avgs_ts %>%
  fabletools::model(feasts::STL(monthly_avg, t.window = 4)) %>% 
  generics::components() %>% 
  autoplot() +
  labs(title = "Quarterly Time Series Analysis of P", x = "Year-Month")
```

```{r}
acf(wq_monthly_avgs_ts, lag.max = 4)
```


```{r}
ggplot(wq_monthly_avgs_df, aes(yr_mo)) +
  scale_x_date(date_breaks = "1 year", date_minor_breaks = "6 months", date_labels = "%Y-%m") +
  geom_line(aes(y=decomp_monthly$season_adjust)) +
  geom_line(aes(y=decomp_monthly$trend), color = "red", linewidth=2) +
  labs(x = 'Year-Month', y = 'Mean concentration (mg/L)', title = "Phosphorus in Chesapeake Bay (2010-2019)", subtitle = "Black: Mean after adjusting for STL monthly seasonality\nRed: STL trend") +
  theme_bw()
```

