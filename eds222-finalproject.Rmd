
```{r}
library(tidyverse)
library(readxl)
library(tsibble)
library(feasts)
library(generics)
```

```{r}
# Create a vector of data URLs
excel_urls <- c(
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2019_CEDR_tidal_data_01jun21.xlsx',
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2018_CEDR_tidal_data_01jun21.xlsx',
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2017_CEDR_tidal_data_11oct18.xlsx',
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2016_CEDR_tidal_data_15jun17.xlsx',
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2015_CEDR_tidal_data_15jun17.xlsx',
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2014_CEDR_tidal_data_15jun17.xlsx',
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2013_CEDR_tidal_data_15jun17.xlsx',
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2012_CEDR_tidal_data_15jun17.xlsx',
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2011_CEDR_tidal_data_15jun17.xlsx',
  'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2010_CEDR_tidal_data_15jun17.xlsx')

# Create a temporary directory to store downloaded files
temp_dir <- tempdir()

# Loop through each URL, extract file name, define local file path, download file, and read into R
for (url in excel_urls) {
  file_name <- basename(url)
  # Define the local file path
  local_path <- file.path(temp_dir, file_name)
  download.file(url, destfile = local_path, mode = "wb")
  wq_data <- readxl::read_excel(local_path, sheet = 1)}

# Wrangle data for relevant column variables and row observations
phos_data <- wq_data %>%
  select("MonitoringLocation", "SampleDate", "Parameter", "MeasureValue", "Unit", "Latitude", "Longitude") %>% 
  filter(Parameter=="TP")

# Remove unnecessary data and values from environment
rm(wq_data)
rm(excel_urls, file_name, local_path, temp_dir)
```

```{r}
# Summarize Phosphorus data by year-month, and store as tsibble
phos_monthly_avgs_ts <- phos_data %>% 
  mutate(yr_mo = tsibble::yearmonth(SampleDate)) %>%
  group_by(yr_mo) %>%
  summarize(monthly_avg = mean(MeasureValue, na.rm = TRUE)) %>% 
  tsibble::as_tsibble()

# Create data.frame version, and convert year-months to Date class (helpful for plotting)
phos_monthly_avgs_df <- as.data.frame(phos_monthly_avgs_ts)
phos_monthly_avgs_df$yr_mo <- as.Date(phos_monthly_avgs_ts$yr_mo, format = "%Y-%m")
```


```{r}
# Plot monthly average Phosphorus concentration as a function of year-month, and add smooth trend line
phos_monthly_avgs_df %>%
  ggplot(aes(x = yr_mo, y = monthly_avg)) +
  stat_summary(geom = 'line', fun = 'mean') +
  geom_smooth(se = FALSE, color = 'blue') +
  labs(x = 'Year-Month', y = 'Mean concentration (mg/L)', title = "Phosphorus in Chesapeake Bay (2010-2019)") +
  scale_x_date(date_breaks = "1 year", date_minor_breaks = "6 months", date_labels = "%Y-%m") +
  theme_bw()
```



```{r}
# Conduct STL time series analysis with yearly seasons, and extract components
decomp_yearly <- phos_monthly_avgs_ts %>%
  fabletools::model(feasts::STL(monthly_avg, t.window = 12)) %>% 
  generics::components()

# Plot STL time series analysis
autoplot(decomp_yearly) +
  labs(title = "STL time series analysis of Phosphorus concentration", x = "Year Month")
```

```{r}
# Plot autocorrelation function with lags going back two yearly seasons
acf(phos_monthly_avgs_ts, lag.max = 24)
```

```{r}
# Plot monthly mean, monthly mean after adjusting for STL yearly seasonality, and STL yearly seasonality
ggplot(phos_monthly_avgs_df, aes(yr_mo)) +
  scale_x_date(date_breaks = "1 year", date_minor_breaks = "6 months", date_labels = "%Y-%m") +
  geom_line(aes(y=decomp_yearly$monthly_avg)) +
  geom_line(aes(y=decomp_yearly$season_year), color="seagreen") +
  geom_line(aes(y=decomp_yearly$season_adjust), color = "cornflowerblue", linewidth=2) +
  labs(x = 'Year-Month',
       y = 'Mean concentration (mg/L)',
       title = "Phosphorus in Chesapeake Bay (2010-2019)",
       subtitle = "Black: Monthly mean\nBlue: Monthly mean after adjusting for STL yearly seasonality\nGreen: STL yearly seasonality") +
  theme_bw()
```


```{r}
# Plot monthly mean after adjusting for STL yearly seasonality, and plot STL trend
ggplot(phos_monthly_avgs_df, aes(yr_mo)) +
  scale_x_date(date_breaks = "1 year", date_minor_breaks = "6 months", date_labels = "%Y-%m") +
  geom_line(aes(y=decomp_yearly$season_adjust)) +
  geom_line(aes(y=decomp_yearly$trend), color = "red", linewidth=2) +
  labs(x = 'Year-Month',
       y = 'Mean concentration (mg/L)',
       title = "Phosphorus in Chesapeake Bay (2010-2019)",
       subtitle = "Black: Monthly mean after adjusting for STL yearly seasonality\nRed: STL trend") +
  theme_bw()
```

