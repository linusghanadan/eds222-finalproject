
```{r}
library(tidyverse)
library(readxl)
library(tsibble)
library(feasts)
library(generics)
```

```{r}
url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2019_CEDR_tidal_data_01jun21.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_19 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2018_CEDR_tidal_data_01jun21.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_18 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2017_CEDR_tidal_data_11oct18.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_17 <-read_excel(path = tf)

url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2016_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_16 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2015_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_15 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2014_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_14 <-read_excel(path = tf)

url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2013_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_13 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2012_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_12 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2011_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_11 <-read_excel(path = tf)

url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2010_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_10 <-read_excel(path = tf)

# Assuming you have a vector of URLs
excel_urls <- c(
  "https://example.com/file1.xlsx",
  "https://example.com/file2.xlsx",
  "https://example.com/file3.xlsx"
)

# Create a temporary directory to store downloaded files
temp_dir <- tempdir()

# Loop through each URL, download the file, and read it into R
for (url in excel_urls) {
  # Extract the file name from the URL
  file_name <- basename(url)
  # Define the local file path
  local_path <- file.path(temp_dir, file_name)
  # Download the file
  download.file(url, destfile = local_path, mode = "wb")
  # Read the Excel file into R (adjust the sheet name or other parameters as needed)
  data <- readxl::read_excel(local_path, sheet = 1)
```

```{r}
wq <- rbind(wq_10, wq_11, wq_12, wq_13, wq_14, wq_15, wq_16, wq_17, wq_18, wq_19)
rm(wq_10, wq_11, wq_12, wq_13, wq_14, wq_15, wq_16, wq_17, wq_18, wq_19)

phos <- wq %>%
  select("MonitoringLocation", "SampleDate", "Parameter", "MeasureValue", "Unit", "Latitude", "Longitude") %>% 
  filter(Parameter=="TP")
rm(wq)
```


```{r}
phos_monthly_avgs_ts <- phos %>% 
  mutate(yr_mo = tsibble::yearmonth(SampleDate)) %>%
  group_by(yr_mo) %>%
  summarize(monthly_avg = mean(MeasureValue, na.rm = TRUE)) %>% 
  as_tsibble()

phos_monthly_avgs_df <- as.data.frame(wq_monthly_avgs_ts)
phos_monthly_avgs_df$yr_mo <- as.Date(wq_monthly_avgs_ts$yr_mo, format = "%Y-%m")
```


```{r}
phos_monthly_avgs_df %>%
  ggplot(aes(yr_mo, monthly_avg)) +
  stat_summary(geom = 'line', fun = 'mean') +
  geom_smooth(se = FALSE, color = 'blue') +
  labs(x = 'Year-Month', y = 'Mean concentration (mg/L)', title = "Phosphorus in Chesapeake Bay (2010-2019)") +
  scale_x_date(date_breaks = "1 year", date_minor_breaks = "6 months", date_labels = "%Y-%m") +
  theme_bw()
```



```{r}
decomp_yearly <- phos_monthly_avgs_ts %>%
  fabletools::model(feasts::STL(monthly_avg, t.window = 12)) %>% 
  generics::components()

autoplot(decomp_yearly) +
  labs(title = "Time series analysis of Phosphorus concentration", x = "Year Month")
```

```{r}
acf(phos_monthly_avgs_ts, lag.max = 24)
```

```{r}
ggplot(phos_monthly_avgs_df, aes(yr_mo)) +
  scale_x_date(date_breaks = "1 year", date_minor_breaks = "6 months", date_labels = "%Y-%m") +
  geom_line(aes(y=decomp_yearly$monthly_avg)) +
  geom_line(aes(y=decomp_yearly$season_year), color="seagreen") +
  geom_line(aes(y=decomp_yearly$season_adjust), color = "cornflowerblue", linewidth=2) +
  labs(x = 'Year-Month',
       y = 'Mean concentration (mg/L)',
       title = "Phosphorus in Chesapeake Bay (2010-2019)",
       subtitle = "Black: Monthly mean\nBlue: Monthly mean after adjusting for STL yearly seasonality\nGreen: STL yearly seasonality") +
  theme_bw()
```


```{r}
ggplot(phos_monthly_avgs_df, aes(yr_mo)) +
  scale_x_date(date_breaks = "1 year", date_minor_breaks = "6 months", date_labels = "%Y-%m") +
  geom_line(aes(y=decomp_yearly$season_adjust)) +
  geom_line(aes(y=decomp_yearly$trend), color = "red", linewidth=2) +
  labs(x = 'Year-Month',
       y = 'Mean concentration (mg/L)',
       title = "Phosphorus in Chesapeake Bay (2010-2019)",
       subtitle = "Black: Monthly mean after adjusting for STL yearly seasonality\nRed: STL trend") +
  theme_bw()
```

