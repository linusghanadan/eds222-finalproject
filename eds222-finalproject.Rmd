
```{r}
library(tidyverse)
library(readxl)
library(tsibble)
library(feasts)
library(generics)
```

```{r}
url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2019_CEDR_tidal_data_01jun21.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_19 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2018_CEDR_tidal_data_01jun21.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_18 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2017_CEDR_tidal_data_11oct18.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_17 <-read_excel(path = tf)

url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2016_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_16 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2015_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_15 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2014_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_14 <-read_excel(path = tf)

url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2013_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_13 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2012_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_12 <-read_excel(path = tf)

url <-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2011_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_11 <-read_excel(path = tf)

url<-'https://datahub-content.chesapeakebay.net/traditional_annual_tidal_02jun21/2010_CEDR_tidal_data_15jun17.xlsx'
tf <- tempfile()
download.file(url, tf)
wq_10 <-read_excel(path = tf)

wq <- rbind(wq_10, wq_11, wq_12, wq_13, wq_14, wq_15, wq_16, wq_17, wq_18, wq_19)

rm(wq_10, wq_11, wq_12, wq_13, wq_14, wq_15, wq_16, wq_17, wq_18, wq_19)
```

```{r}
wq <- wq %>%
  select("MonitoringLocation", "SampleDate", "Parameter", "MeasureValue", "Unit", "Latitude", "Longitude") %>% 
  filter(Parameter=="TP")

class(wq$SampleDate)
```

```{r}
wq_monthly_avgs <- wq %>% 
  mutate(yr_mo = tsibble::yearmonth(SampleDate)) %>%
  group_by(yr_mo) %>%
  summarize(monthly_avg = mean(MeasureValue, na.rm = TRUE))
```

```{r}
wq_monthly_avgs$yr_mo <- as.Date(wq_monthly_avgs$yr_mo)

class(wq_monthly_avgs$yr_mo)
```


```{r}
wq_monthly_avgs %>%
  ggplot(aes(yr_mo, monthly_avg)) +
  stat_summary(geom = 'line', fun = 'mean') +
  geom_smooth(se = FALSE, color = 'blue') +
  labs(x = 'Month', y = 'Average TN measurement (mg/L)', title = "Nitrogen Pollution in Chesapeake Bay (2010-2020)") +
  scale_x_date(date_breaks = "1 year", date_minor_breaks = "6 months", date_labels = "%Y-%m") +
  theme_bw()
```


```{r}
# dcmp2 = weather_ts %>% model(STL(avg_mean_airtemp, t.window = 12*5))
# 
# components(dcmp2) %>%
# filter(year(yr_mo) > 1989) %>%
# as_tsibble() %>%
# autoplot(trend, colour = "red") + geom_line(aes(y=season_adjust), colour = "gray", alpha = .4) + lims(y=c(0, 15)) +
# labs(y = "Monthly Mean Air Temperature (Celsius)", x = "Year",
#        title = "Mean Annual Temperature", subtitle = "Madison, WI")
```


```{r}
wq_monthly_avgs <- as_tsibble(wq_monthly_avgs)

wq_monthly_avgs %>% model(classical_decomposition(monthly_avg, type = "additive")) %>% 
  generics::components() %>% 
  autoplot() +
  labs(title = "Time Series Analysis of Nitrogen Pollution")
```

